<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title> Shipment </title>

  <link rel="stylesheet" as="style" crossorigin
    href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.css" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --bg1:#f7f4ff; --bg2:#eef6ff;
      --card:rgba(255,255,255,.9);
      --stroke:rgba(170,150,230,.22);
      --text:#2f2a3a;
      --shadow:0 18px 50px rgba(30,18,60,.10);
      --shadow2:0 10px 26px rgba(30,18,60,.08);

      --low-bg: rgba(255, 70, 70, .10);
      --low-border: rgba(255, 70, 70, .35);
      --low-text: rgba(160, 20, 20, .95);

      --out-bg: rgba(255, 35, 35, .16);
      --out-border: rgba(255, 35, 35, .55);
      --out-text: rgba(135, 0, 0, .98);

      --na-bg: rgba(120,120,140,.10);
      --na-border: rgba(120,120,140,.35);
      --na-text: rgba(80,80,95,.95);

      --ok-bg: rgba(184,167,255,.14);
      --ok-border: rgba(170,150,230,.35);
      --ok-text: rgba(47,42,58,.92);

      --pink:#ff8fbc;
    }

    *{box-sizing:border-box;font-family:"Pretendard",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;}
    body{
      margin:0; min-height:100vh; color:var(--text);
      background:
        radial-gradient(900px 520px at 20% 18%, rgba(255,143,188,.25), transparent 60%),
        radial-gradient(900px 520px at 82% 24%, rgba(184,167,255,.20), transparent 58%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
    }
    .field-label{
      font-size:12px;
      opacity:.75;
      white-space:nowrap;
      min-width:52px;
      flex:0 0 auto;
    }

    .container{max-width:1400px;margin:0 auto;padding:28px 16px 46px;}
    .card{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:20px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card-inner{padding:18px;}
    .title{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      font-size:18px; font-weight:900;
    }
    .meta{
      margin-top:8px; display:flex; flex-wrap:wrap; gap:8px;
      color:rgba(110,106,130,.85); font-size:12px;
      align-items:center;
      line-height:1.2;
    }
    .pill{
      font-size:11px; padding:5px 10px; border-radius:999px;
      background: linear-gradient(90deg, rgba(255,143,188,.20), rgba(184,167,255,.16));
      border:1px solid rgba(170,150,230,.25);
      box-shadow: 0 1px 0 rgba(255,255,255,.55) inset;
      text-decoration:none; color:rgba(47,42,58,.82);
      display:inline-flex; align-items:center; gap:6px;
    }
    .pill:hover{
      border-color: rgba(255,143,188,.55);
      box-shadow: 0 0 0 3px rgba(255,143,188,.14), 0 1px 0 rgba(255,255,255,.55) inset;
    }

    .row{display:flex; gap:10px; align-items:center; margin-top:14px; flex-wrap:wrap;}
    .input{
      flex:1; min-width:240px;
      display:flex; align-items:center; gap:8px;
      padding:10px 12px; border-radius:14px;
      background:rgba(243,241,250,.85);
      border:1px solid rgba(170,150,230,.20);
      box-shadow: var(--shadow2);
    }
    .input input{
      width:100%; border:0; outline:0; background:transparent;
      font-size:13px;
    }

    .btn{
      border:0; cursor:pointer;
      padding:10px 14px; border-radius:14px;
      background:rgba(255,255,255,.82);
      border:1px solid rgba(170,150,230,.25);
      box-shadow: var(--shadow2);
      font-weight:900;
    }
    .btn:hover{border-color: rgba(255,143,188,.55); box-shadow: 0 0 0 3px rgba(255,143,188,.12), var(--shadow2);}
    .btn:disabled{cursor:not-allowed; opacity:.55; filter:saturate(.8); box-shadow:none;}

    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 10px; border-radius:999px;
      border:1px solid rgba(170,150,230,.25);
      background: rgba(255,255,255,.70);
      font-weight:900;
      font-size:11px;
      white-space:nowrap;
    }
    .badge.ok{ background: var(--ok-bg); border-color: var(--ok-border); color: var(--ok-text); }
    .badge.low{ background: var(--low-bg); border-color: var(--low-border); color: var(--low-text); }
    .badge.out{ background: var(--out-bg); border-color: var(--out-border); color: var(--out-text); }
    .badge.na{ background: var(--na-bg); border-color: var(--na-border); color: var(--na-text); }

    .warnline{font-size:11px; font-weight:900;}
    .warnline.low{color: var(--low-text);}
    .warnline.out{color: var(--out-text);}
    .warnline.na{color: var(--na-text);}

    .table-wrap{
      margin-top:14px;
      border-radius:16px; border:1px solid rgba(170,150,230,.18);
      overflow:auto; background: rgba(255,255,255,.68);
      box-shadow: 0 1px 0 rgba(255,255,255,.70) inset;
      max-height: 72vh;
      scrollbar-gutter: stable;
    }
    table{width:100%; border-collapse:separate; border-spacing:0; font-size:12px;}
    thead th{
      position:sticky; top:0; z-index:2;
      text-align:left; padding:10px 12px;
      background: rgba(255,255,255,.86);
      border-bottom: 1px solid rgba(170,150,230,.18);
      font-weight:900;
      white-space:nowrap;
    }
    tbody td{
      padding:10px 12px;
      border-bottom:1px solid rgba(170,150,230,.12);
      vertical-align:top;
      white-space: nowrap;
    }
    tbody tr:nth-child(even){background: rgba(243,241,250,.55);}
    tbody tr:hover{background: linear-gradient(90deg, rgba(255,143,188,.18), rgba(184,167,255,.14));}
    .no-data{padding:20px 14px; text-align:center; color: rgba(110,106,130,.75); font-size:12px;}

    tr.low  { background: var(--low-bg) !important; }
    tr.out  { background: var(--out-bg) !important; }
    tr.na   { background: rgba(120,120,140,.07) !important; }

    .copy{cursor:pointer;}
    .chkcell{ text-align:center; }

    .panel{
      margin-top: 12px;
      padding: 12px;
      border-radius: 16px;
      border: 1px dashed rgba(170,150,230,.35);
      background: rgba(255,255,255,.65);
      display:none;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .panel.show{display:flex;}
    .panel .label{
      font-size:12px;
      font-weight:900;
      color: rgba(47,42,58,.88);
    }
    .miniinput{
      display:flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:12px;
      background: rgba(243,241,250,.85);
      border:1px solid rgba(170,150,230,.20);
      box-shadow: var(--shadow2);
    }
    .miniinput input{
      border:0; outline:0; background:transparent; width:220px; font-size:12.5px;
    }
    .minihelp{
      font-size:11px;
      color: rgba(110,106,130,.85);
    }

    /* ✅ select 기본 스타일(입력 느낌) */
    .miniinput select{
      border:0; outline:0; background:transparent;
      width: 280px;
      font-size:12.5px;
    }

    #toast{
      position:fixed; right:18px; bottom:18px; z-index:9999;
      padding:10px 12px; border-radius:14px;
      background: rgba(255,255,255,.90);
      border:1px solid rgba(255,143,188,.35);
      box-shadow: var(--shadow);
      opacity:0; transform: translateY(10px);
      transition:.18s ease;
      pointer-events:none;
      font-weight:900;
    }
    #toast.show{opacity:1; transform:translateY(0);}

    /* ===================== UX 업그레이드 ===================== */

    /* 버튼/입력 포커스 통일 */
    .input:focus-within,
    .miniinput:focus-within{
      border-color: rgba(255,143,188,.55);
      box-shadow: 0 0 0 3px rgba(255,143,188,.12), var(--shadow2);
    }

    /* 상태/배지 영역 정리 */
    #status{ font-weight:900; }
    #stat2{ opacity:.75; }
    #copyGateMsg{
      padding:4px 8px;
      border-radius:999px;
      background: rgba(255,255,255,.55);
      border:1px solid rgba(170,150,230,.18);
    }

    /* 행 강조: 체크된 행 하이라이트 */
    tr.is-selected{
      outline: 2px solid rgba(255,143,188,.45);
      outline-offset: -2px;
      background: linear-gradient(90deg, rgba(255,143,188,.22), rgba(184,167,255,.18)) !important;
    }

    /* 변경 패널: 더 “툴” 같은 느낌 */
    #changePanel{
      position: sticky;
      bottom: 10px;
      z-index: 50;
      backdrop-filter: blur(10px);
    }
    #changePanel.show{
      box-shadow: 0 18px 50px rgba(30,18,60,.12);
    }

    /* 선택/복사 툴바(상단) */
    .toolbar{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(170,150,230,.18);
      background: rgba(255,255,255,.65);
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .toolbar .hint{
      font-size:11px;
      opacity:.75;
    }
    .kbd{
      font-size:11px;
      border:1px solid rgba(170,150,230,.25);
      padding:2px 6px;
      border-radius:8px;
      background: rgba(255,255,255,.70);
      font-weight:900;
    }

    /* 로딩 스피너 */
    .spinner{
      width:14px; height:14px;
      border-radius:50%;
      border:2px solid rgba(170,150,230,.25);
      border-top-color: rgba(255,143,188,.85);
      display:inline-block;
      animation: spin .8s linear infinite;
      vertical-align:-2px;
    }
    @keyframes spin{
      to{ transform: rotate(360deg); }
    }

    /* ===================== 셀 호버 미리보기(툴팁) ===================== */
    td.copy{
      position: relative;
      user-select: none;
    }

    td.copy::after{
      content: attr(data-preview);
      position: absolute;
      left: 10px;
      top: calc(100% + 6px);
      z-index: 9999;

      max-width: min(520px, 90vw);
      white-space: normal;
      word-break: break-word;

      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(170,150,230,.35);
      background: rgba(255,255,255,.96);
      box-shadow: 0 18px 50px rgba(30,18,60,.12);

      font-size: 12px;
      font-weight: 700;
      color: rgba(47,42,58,.95);

      opacity: 0;
      transform: translateY(-4px);
      pointer-events: none;
      transition: .12s ease;
    }

    td.copy:hover::after{
      opacity: 1;
      transform: translateY(0);
    }

    td.copy[data-preview=""]::after{
      display:none;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="card">
      <div class="card-inner">

        <div class="title">
          <div> Shipment </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <a class="pill" id="orderLink" href="#" target="_blank" rel="noopener noreferrer">발주서</a>
            <a class="pill" id="stockLink" href="#" target="_blank" rel="noopener noreferrer">재고</a>
            <a class="pill" id="existLink" href="#" target="_blank" rel="noopener noreferrer"> 출고 </a>
          </div>
        </div>

        <div class="meta">
          <span id="status">로딩 중…</span>
          <span id="stat2"></span>
          <span id="stockSummary"></span>
          <span id="copyGateMsg"></span>
        </div>

        <!-- 기존 등록 데이터 토글 패널 -->
        <div class="panel" id="existPanel" style="display:none;">
          <span class="label">기존 등록 데이터</span>
          <button class="btn" id="btnExistToggle" type="button">펼치기</button>

          <div id="existBody" style="display:none; width:100%;">
            <div class="toolbar" id="tableToolbar" style="display:none;">
              <span class="hint">
                행 클릭하면 복사 · 여러 건이면 체크 후 <span class="kbd">변경</span> 적용
              </span>
              <span id="selCount" class="badge ok" style="display:none;">선택 0건</span>
              <button class="btn" id="btnSelectAll" type="button" style="display:none;">전체 선택</button>
              <button class="btn" id="btnSelectNone" type="button" style="display:none;">선택 해제</button>
            </div>

            <div class="table-wrap" style="max-height:240px; width:100%; margin-top:8px;">
              <table style="width:100%; border-collapse:separate; border-spacing:0; font-size:12px;">
                <thead>
                  <tr>
                    <th>사방넷주문번호</th>
                    <th>쇼핑몰 주문번호</th>
                    <th>목적(D)</th>
                    <th>전산 처리 방법(E)</th>
                    <th>기록일(있으면)</th>
                  </tr>
                </thead>
                <tbody id="existTbody"></tbody>
              </table>
            </div>
            <div class="minihelp" style="margin-top:8px;">
              ※ 이 주문번호로 이미 입력된 목적/전산 처리 방법이 있으면 여기서 확인됩니다.
            </div>
          </div>
        </div>

        <div class="row">
          <div class="input">
            <span class="field-label">주문번호</span>
            <input id="orderInput" type="text" placeholder="쇼핑몰 주문번호 입력" />
          </div>
          <button class="btn" id="btnSearch">조회</button>
          <button class="btn" id="btnCopy" disabled>복사</button>
          <button class="btn" id="btnClear">초기화</button>
        </div>

        <!-- 발주서에 주문번호 없을 때: 수동 입력 -->
        <div class="panel" id="manualPanel">
          <span class="label">발주서에 없음 → 수동 입력</span>

          <div class="miniinput">
            <span style="font-size:11px;opacity:.75;">상품컬러코드</span>
            <input id="manualColor" type="text" placeholder="예: ABC123 (필수)" />
          </div>

          <div class="miniinput" style="width:180px;">
            <span style="font-size:11px;opacity:.75;">수량</span>
            <input id="manualQty" type="text" placeholder="예: 1" />
          </div>

          <button class="btn" id="btnManualApply">적용</button>
          <span class="minihelp">재고 10 미만/0/미등록이면 복사 차단</span>
        </div>

        <!-- 발주서에서 불러온 후: 상품 변경 -->
        <div class="panel" id="changePanel">
          <span class="label">변경</span>

          <!-- ✅ 색상명(I열)만 표시 / LOW·OUT·N/A는 보이지만 선택 불가 -->
          <div class="miniinput">
            <span style="font-size:11px;opacity:.75;">색상 선택</span>
            <select id="changeColorSelect" title="색상명(I열)로 선택하면 컬러코드가 자동 입력됩니다. (LOW/OUT/N/A는 선택 불가)">
              <option value="">선택하세요</option>
            </select>
          </div>

          <div class="miniinput">
            <span style="font-size:11px;opacity:.75;">컬러코드</span>
            <input id="changeColor" type="text" placeholder="예: ABC123 (필수)" />
          </div>

          <div class="miniinput" style="width:180px;">
            <span style="font-size:11px;opacity:.75;">수량</span>
            <input id="changeQty" type="text" placeholder="예: 1" />
          </div>

          <button class="btn" id="btnChangeApply">적용</button>
          <button class="btn" id="btnChangeReset">취소</button>
        </div>

        <div class="table-wrap" id="tableWrap">
          <div class="no-data">검색 결과가 없습니다.</div>
        </div>

      </div>
    </div>
  </div>

  <div id="toast"> copy </div>

<script>
/* ===================== 기준 ===================== */
const LOW_STOCK_THRESHOLD = 10;

/* ===================== 시트 ===================== */
// 발주서
const ORDER_SHEET_URL_VIEW =
  "https://docs.google.com/spreadsheets/d/1_Bxfag-90U6u-6JbhxNqeoD9vRns-CpPeXPIJYO1Z5o/edit?gid=518656308#gid=518656308";
const ORDER_CSV_BASE =
  "https://docs.google.com/spreadsheets/d/1_Bxfag-90U6u-6JbhxNqeoD9vRns-CpPeXPIJYO1Z5o/export?format=csv&gid=518656308";

// 재고 시트
const STOCK_SHEET_URL_VIEW =
  "https://docs.google.com/spreadsheets/d/1_L12NKkBVU4c5xDPrYLUQRnSUG2NoAwYGWIfPDVO3bM/edit?gid=366983013#gid=366983013";
const STOCK_CSV_BASE =
  "https://docs.google.com/spreadsheets/d/1_L12NKkBVU4c5xDPrYLUQRnSUG2NoAwYGWIfPDVO3bM/export?format=csv&gid=366983013";

// 목적/전산 처리 방법(출고) 시트
const EXIST_SHEET_URL_VIEW =
  "https://docs.google.com/spreadsheets/d/1LPy69E2yPTaSwxFAYrX6qV0BZx1tW0YdonLRNqeo5Vc/edit?gid=0#gid=0";
const EXIST_CSV_BASE =
  "https://docs.google.com/spreadsheets/d/1LPy69E2yPTaSwxFAYrX6qV0BZx1tW0YdonLRNqeo5Vc/export?format=csv&gid=0";

document.getElementById("orderLink").href = ORDER_SHEET_URL_VIEW;
document.getElementById("stockLink").href = STOCK_SHEET_URL_VIEW;
document.getElementById("existLink").href = EXIST_SHEET_URL_VIEW;

/* ===================== 강제 포함 B/C/D ===================== */
// CSV 0-based: A=0, B=1, C=2, D=3
const EXTRA_COLS = [
  { key: "__B", label: "사방넷주문번호", idx: 1 },
  { key: "__C", label: "쇼핑몰 주문번호(필수)", idx: 2 },
  { key: "__D", label: "쇼핑몰", idx: 3 },
];

/* ===================== 요청 출력 컬럼 ===================== */
const OUTPUT_HEADERS = [
  "요청일",
  "수령인","배송수단","운송장 번호","받는분연락처","받는분 기타연락처","주소","배송메세지",
  "상품명","수량","결제금액","큐텐(한글상품명)","바코드","큐텐바코드",
  "상품코드","쇼핑몰(참고용)","상품컬러코드","상품명(수집)","옵션(수집)","주문자명",
  "비고"
];

/* ===================== 결과 테이블 컬럼(화면 숨김 + 복사 전체 포함) ===================== */
const HIDE_IN_VIEW = new Set([
  "배송수단","운송장 번호","받는분연락처","받는분 기타연락처","주소","배송메세지",
  "큐텐(한글상품명)","큐텐바코드","쇼핑몰(참고용)",
]);

const TABLE_COLS_COPY = [
  { key: "요청일", label: "요청일" },
  ...EXTRA_COLS.map(c => ({ key:c.key, label:c.label })),
  { key: "수령인", label: "수령인" },
  ...OUTPUT_HEADERS
    .filter(h => !["요청일","수령인"].includes(h))
    .map(h => ({ key:h, label:h }))
];

const TABLE_COLS_VIEW = TABLE_COLS_COPY.filter(c => !HIDE_IN_VIEW.has(c.label));

const COL_WIDTH = {
  "요청일": 80,
  "사방넷주문번호": 100,
  "쇼핑몰 주문번호(필수)": 120,
  "상품명": 250,
  "바코드": 120,
  "상품코드": 100,
  "상품컬러코드": 120,
  "  옵션": 100,
  "_default": 60
};

/* ===================== 유틸 ===================== */
const $ = (id)=>document.getElementById(id);

function showToast(msg="복사됨"){
  const el = $("toast");
  el.textContent = msg;
  el.classList.add("show");
  setTimeout(()=>el.classList.remove("show"), 850);
}

function withCacheBust(url){
  const sep = url.includes("?") ? "&" : "?";
  return `${url}${sep}_=${Date.now()}`;
}

function looksLikeBadCsv(text){
  const t = String(text || "").trim();
  if(!t) return true;
  const head = t.slice(0, 200).toLowerCase();
  if(head.includes("<!doctype") || head.includes("<html") || head.includes("servicelogin")) return true;
  if(t.length < 30) return true;
  return false;
}

async function fetchText(url, timeoutMs = 9000){
  const controller = new AbortController();
  const t = setTimeout(()=>controller.abort(), timeoutMs);
  try{
    const res = await fetch(url, { signal: controller.signal, cache: "no-store" });
    if(!res.ok) throw new Error("HTTP " + res.status);
    return await res.text();
  } finally {
    clearTimeout(t);
  }
}

async function fetchCsvSmart(baseUrl, timeoutMs=9000){
  const t1 = await fetchText(baseUrl, timeoutMs).catch(()=> "");
  if(!looksLikeBadCsv(t1)) return t1;

  const t2 = await fetchText(withCacheBust(baseUrl), timeoutMs).catch(()=> "");
  if(!looksLikeBadCsv(t2)) return t2;

  return t2 || t1;
}

function normalizeKey(v){
  return String(v ?? "")
    .replace(/[\u200B-\u200D\uFEFF]/g, "")
    .trim();
}

function normalizeOrderNo(v){
  return normalizeKey(v);
}

function normColorCode(v){
  return normalizeKey(v).replace(/\s+/g,"").replace(/-/g,"").toUpperCase();
}

function normProductCode_(v){
  return normalizeKey(v).replace(/\s+/g,"").toUpperCase();
}

function toNumber(v){
  const n = String(v ?? "").replace(/[^0-9.-]/g,"");
  return Number(n) || 0;
}

function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function safeGet(row, idx){
  if(!row || idx == null || idx < 0) return "";
  return (row[idx] ?? "");
}

/* ===================== 로딩 UI ===================== */
function setLoadingUI_(on, msg){
  const st = $("status");
  if(!st) return;
  if(on){
    st.innerHTML = `<span class="spinner"></span> ${escapeHtml(msg || "로딩 중…")}`;
  }else{
    st.textContent = msg || "로딩 완료";
  }
}

/* ===================== 매칭 컬럼: 헤더로 찾기 ===================== */
let headerIndexMap = new Map();
function getMatchIndexFromHeader_(){
  const idx = headerIndexMap.get("쇼핑몰 주문번호(필수)");
  if(idx == null){
    const idx2 = headerIndexMap.get("쇼핑몰 주문번호");
    if(idx2 != null) return idx2;
  }
  return 2;
}

/* ===================== 재고/상품명 유틸 ===================== */
let stockMap = new Map();
let stockInfoMap = new Map();

function colorNameFromStock_(colorCodeRaw){
  const code = normColorCode(colorCodeRaw);
  if(!code) return "";
  const info = stockInfoMap.get(code);
  return (info?.colorName || "").trim(); // I열
}

function stockQtyLabel_(colorCodeRaw){
  const code = normColorCode(colorCodeRaw);
  if(!code) return "미등록";
  if(!stockMap.has(code)) return "미등록";
  return String(stockMap.get(code));
}

function stripStockTag_(s){
  return String(s ?? "").replace(/\s*\[재고:.*?\]\s*/g, " ").trim();
}

function attachStockToRequestDate_(reqDate, colorCode){
  const base = stripStockTag_(reqDate);
  const code = normColorCode(colorCode);
  let qtyLabel = "미등록";
  if(code && stockMap.has(code)) qtyLabel = String(stockMap.get(code));
  const tag = `[재고:${qtyLabel}]`;
  return base ? `${base}  ${tag}` : tag;
}

function nameFromStock_(colorCodeRaw){
  const code = normColorCode(colorCodeRaw);
  if(!code) return "";
  const info = stockInfoMap.get(code);
  if(!info) return "";

  const a = (info.name || "").trim();       // F
  const b = (info.colorName || "").trim();  // I
  if(a && b) return `${a} ${b}`;
  return a || b || "";
}

function stockStatusByColorCode(colorCodeRaw){
  const code = normColorCode(colorCodeRaw);
  if(!code) return { type:"na", label:"재고 미등록", qty:null };

  if(!stockMap.has(code)){
    return { type:"na", label:"재고 미등록", qty:null };
  }

  const qty = stockMap.get(code);
  if(qty <= 0) return { type:"out", label:`재고 0`, qty };
  if(qty < LOW_STOCK_THRESHOLD) return { type:"low", label:`재고 ${qty} (${LOW_STOCK_THRESHOLD} 미만)`, qty };
  return { type:"ok", label:`재고 ${qty}`, qty };
}

function badgeHtml(type, text){
  const cls = type === "ok" ? "badge ok"
            : type === "low" ? "badge low"
            : type === "out" ? "badge out"
            : "badge na";
  return `<span class="${cls}">${escapeHtml(text)}</span>`;
}

/* ===================== ✅ 색상 드롭다운 ===================== */
let colorSelectWired = false;

function getAllowedProductCodesForDropdown_(){
  if(!lastOutRows || lastOutRows.length === 0) return new Set();

  let idxs = [];
  if(lastOutRows.length > 1){
    idxs = getCheckedIndexes_();
  }
  if(!idxs.length) idxs = [0];

  const set = new Set();
  for(const idx of idxs){
    const pc = normProductCode_(lastOutRows[idx]?.["상품코드"]);
    if(pc) set.add(pc);
  }
  return set;
}

function rebuildColorSelectOptions_(allowedProductCodes){
  const sel = $("changeColorSelect");
  if(!sel) return;

  const allowAll = !allowedProductCodes || allowedProductCodes.size === 0;

  sel.innerHTML = `<option value="">선택하세요</option>`;

  const items = [];
  stockInfoMap.forEach((info, code)=>{
    const color = (info?.colorName || "").trim();
    const label = color || "(색상명 없음)";

    let isAllowed = true;
    if(!allowAll){
      isAllowed = Array.from(allowedProductCodes).some(pc => String(code).startsWith(pc));
    }
    if(!isAllowed) return;

    const st = stockStatusByColorCode(code);
    items.push({ code, label, type: st.type });
  });

  items.sort((a,b)=>{
    const c = a.label.localeCompare(b.label, "ko");
    if(c !== 0) return c;
    return a.code.localeCompare(b.code);
  });

  const frag = document.createDocumentFragment();
  for(const it of items){
    const opt = document.createElement("option");
    opt.value = it.code;

    const tag = it.type === "ok" ? ""
              : it.type === "low" ? " (LOW)"
              : it.type === "out" ? " (OUT)"
              : " (N/A)";

    opt.textContent = `${it.label}${tag}`;
    if(it.type !== "ok") opt.disabled = true;

    frag.appendChild(opt);
  }
  sel.appendChild(frag);
}

function refreshColorDropdownByCurrentRows_(){
  const allowed = getAllowedProductCodesForDropdown_();
  rebuildColorSelectOptions_(allowed);

  const sel = $("changeColorSelect");
  const code = normColorCode($("changeColor")?.value || "");
  const st = stockStatusByColorCode(code);
  if(sel){
    sel.value = (st.type === "ok") ? code : "";
  }
}

function wireColorSelect_(){
  if(colorSelectWired) return;
  const sel = $("changeColorSelect");
  const input = $("changeColor");
  if(!sel || !input) return;

  sel.addEventListener("change", ()=>{
    const code = sel.value;
    if(code){
      input.value = code;
      input.dispatchEvent(new Event("input", { bubbles:true }));
    }
  });

  input.addEventListener("input", ()=>{
    const code = normColorCode(input.value);
    const st = stockStatusByColorCode(code);

    if(st.type === "ok"){
      sel.value = code;
    }else{
      sel.value = "";
    }
  });

  colorSelectWired = true;
}

/* ===================== UI ===================== */
function clearStockUI(){
  $("stockSummary").textContent = "";
  $("copyGateMsg").textContent = "";
  $("copyGateMsg").className = "";
}
function setPanel(which, on){
  const el = which === "manual" ? $("manualPanel") : $("changePanel");
  el.classList.toggle("show", !!on);
}
function gateCopyByTypes(types){
  let ok=0, low=0, out=0, na=0;
  for(const t of types){
    if(t === "ok") ok++;
    else if(t === "low") low++;
    else if(t === "out") out++;
    else na++;
  }

  const badges = [];
  if(out) badges.push(badgeHtml("out", `OUT ${out}건`));
  if(low) badges.push(badgeHtml("low", `LOW ${low}건`));
  if(na)  badges.push(badgeHtml("na", `N/A ${na}건`));
  if(!out && !low && !na) badges.push(badgeHtml("ok", `OK ${ok}건`));
  $("stockSummary").innerHTML = badges.join(" ");

  const blocked = (out > 0 || low > 0 || na > 0);
  $("btnCopy").disabled = blocked;

  if(blocked){
    if(out > 0){
      $("copyGateMsg").textContent = "출고요청 방지: 재고 0(OUT) 포함";
      $("copyGateMsg").className = "warnline out";
    }else if(low > 0){
      $("copyGateMsg").textContent = `출고요청 방지: 재고 ${LOW_STOCK_THRESHOLD} 미만(LOW) 포함`;
      $("copyGateMsg").className = "warnline low";
    }else{
      $("copyGateMsg").textContent = "출고요청 방지: 재고 미등록(N/A) 포함";
      $("copyGateMsg").className = "warnline na";
    }
  }else{
    $("copyGateMsg").textContent = "복사 가능";
    $("copyGateMsg").className = "warnline";
  }
}

/* ===================== 기존 데이터(목적/처리) 토글 ===================== */
let existRows = [];
let existHeaderMap = new Map();
let existIndexBySabang = new Map();
let existIndexByMall = new Map();

function hideExistPanel(){
  const p = $("existPanel");
  if (!p) return;
  p.style.display = "none";
  $("existBody").style.display = "none";
  $("btnExistToggle").textContent = "펼치기";
  $("existTbody").innerHTML = "";
}

function showExistPanelByOrderNo_(orderNo){
  const keyMall = normalizeOrderNo(orderNo);

  const rowsByMall = existIndexByMall.get(keyMall) || [];

  const sabangKeys = [];
  if(lastSource === "sheet" && lastOutRows && lastOutRows.length){
    for(const o of lastOutRows){
      const v = normalizeKey(o["__B"]);
      if(v) sabangKeys.push(v);
    }
  }
  const rowsBySabang = sabangKeys.flatMap(k => existIndexBySabang.get(k) || []);
  const merged = [...rowsByMall, ...rowsBySabang];

  const uniq = [];
  const seen = new Set();
  for(const r of merged){
    const sig = JSON.stringify(r);
    if(seen.has(sig)) continue;
    seen.add(sig);
    uniq.push(r);
  }

  if(uniq.length === 0){
    hideExistPanel();
    return;
  }

  const panel = $("existPanel");
  panel.style.display = "flex";
  $("existBody").style.display = "none";
  $("btnExistToggle").textContent = `펼치기 (${uniq.length}건)`;

  const sabangIdx =
    existHeaderMap.get("사방넷주문번호") ??
    existHeaderMap.get("사방넷 주문번호") ??
    null;

  const mallIdx =
    existHeaderMap.get("쇼핑몰 주문번호(필수)") ??
    existHeaderMap.get("쇼핑몰 주문번호") ??
    null;

  const dateIdx =
    existHeaderMap.get("기록일") ??
    existHeaderMap.get("등록일") ??
    existHeaderMap.get("작성일") ??
    null;

  $("existTbody").innerHTML = uniq.map(r=>{
    const sabang = safeGet(r, sabangIdx);
    const mall = safeGet(r, mallIdx);
    const purpose = safeGet(r, 3);
    const method  = safeGet(r, 4);
    const dt = safeGet(r, dateIdx);

    return `
      <tr>
        <td>${escapeHtml(sabang)}</td>
        <td>${escapeHtml(mall)}</td>
        <td>${escapeHtml(purpose)}</td>
        <td>${escapeHtml(method)}</td>
        <td>${escapeHtml(dt)}</td>
      </tr>
    `;
  }).join("");
}

/* ===================== 데이터 저장 (발주서) ===================== */
let orderRows = [];
let orderIndexMap = new Map();

/* ===================== 상태 ===================== */
let lastOutRows = [];
let lastStockTypes = [];
let originalOutRows = [];
let lastSource = "none";

/* ===================== 로딩 상태 플래그 ===================== */
let stockLoaded = false;
let orderLoaded = false;
let existLoaded = false;
let orderExistLoadingPromise = null;

/* ===================== localStorage 캐시 (재고만) ===================== */
const STOCK_CACHE_KEY = "SHIPMENT_STOCK_CSV_CACHE_V1";
const STOCK_CACHE_TTL_MS = 10 * 60 * 1000; // 10분

function loadStockCache_(){
  try{
    const raw = localStorage.getItem(STOCK_CACHE_KEY);
    if(!raw) return null;
    const obj = JSON.parse(raw);
    if(!obj || !obj.csv || !obj.ts) return null;
    if(Date.now() - obj.ts > STOCK_CACHE_TTL_MS) return null;
    return obj.csv;
  }catch{
    return null;
  }
}
function saveStockCache_(csv){
  try{
    localStorage.setItem(STOCK_CACHE_KEY, JSON.stringify({ ts: Date.now(), csv }));
  }catch{}
}

/* ===================== 파서 ===================== */
function parseCsvWithPapa(csvText, onDone){
  Papa.parse(csvText, {
    skipEmptyLines: true,
    worker: true,
    complete: (results)=> onDone(results)
  });
}

/* ===================== 1) 재고만 먼저 로드 ===================== */
async function loadStockOnly(){
  setLoadingUI_(true, "재고 로딩 중…");
  $("stat2").textContent = "";
  clearStockUI();
  hideExistPanel();
  setPanel("manual", false);
  setPanel("change", false);
  $("btnCopy").disabled = true;

  wireColorSelect_();

  try{
    const cached = loadStockCache_();
    if(cached){
      await new Promise((resolve)=>{
        parseCsvWithPapa(cached, (results)=>{
          buildStockMapsFromParsed_(results);
          resolve();
        });
      });
      stockLoaded = true;

      rebuildColorSelectOptions_();
      setLoadingUI_(false, "재고 로딩 완료 (캐시)");
      $("stat2").textContent = `재고 ${stockMap.size.toLocaleString()}개 · 발주/출고는 조회 시 불러옵니다`;
    }

    const stockCsv = await fetchCsvSmart(STOCK_CSV_BASE);
    if(!looksLikeBadCsv(stockCsv)){
      saveStockCache_(stockCsv);
      await new Promise((resolve)=>{
        parseCsvWithPapa(stockCsv, (results)=>{
          buildStockMapsFromParsed_(results);
          resolve();
        });
      });
      stockLoaded = true;

      rebuildColorSelectOptions_();
      setLoadingUI_(false, "재고 로딩 완료");
      $("stat2").textContent = `재고 ${stockMap.size.toLocaleString()}개 · 발주/출고는 조회 시 불러옵니다`;
    }else{
      if(!stockLoaded){
        setLoadingUI_(false, "재고 로드 실패: 시트 공개(보기 가능) 확인");
      }
    }
  }catch(e){
    console.error(e);
    if(!stockLoaded){
      setLoadingUI_(false, "재고 로드 실패: 시트 공개(보기 가능) 확인");
    }
  }
}

function buildStockMapsFromParsed_(results){
  const rows = (results.data || []).slice(1).filter(r => r && r.length > 0);
  stockMap = new Map();
  stockInfoMap = new Map();

  for(const r of rows){
    const code = normColorCode(r[0]);
    if(!code) continue;

    const name = normalizeKey(r[5]);
    const colorName = normalizeKey(r[8]);
    const qty = toNumber(r[10]);

    stockMap.set(code, qty);
    stockInfoMap.set(code, { qty, name, colorName });
  }
}

/* ===================== 2) 발주서+출고는 조회 시 1회 Lazy Load ===================== */
async function ensureOrderAndExistLoaded_(){
  if(orderLoaded && existLoaded) return;
  if(orderExistLoadingPromise) return orderExistLoadingPromise;

  orderExistLoadingPromise = (async ()=>{
    setLoadingUI_(true, "발주/출고 데이터 불러오는 중…");
    $("btnSearch").disabled = true;
    try{
      const [orderCsv, existCsv] = await Promise.all([
        fetchCsvSmart(ORDER_CSV_BASE),
        fetchCsvSmart(EXIST_CSV_BASE),
      ]);

      await new Promise((resolve)=>{
        parseCsvWithPapa(orderCsv, (results)=>{
          const rows = results.data || [];
          const header = (rows[0] || []).map(h => normalizeKey(h));

          headerIndexMap = new Map();
          header.forEach((h, idx)=>{ if(h) headerIndexMap.set(h, idx); });

          orderRows = rows.slice(1).filter(r => r && r.length > 1);

          const matchIdx = getMatchIndexFromHeader_();

          orderIndexMap = new Map();
          for(const r of orderRows){
            const k = normalizeOrderNo(r[matchIdx]);
            if(!k) continue;
            if(!orderIndexMap.has(k)) orderIndexMap.set(k, []);
            orderIndexMap.get(k).push(r);
          }

          orderLoaded = true;
          resolve();
        });
      });

      await new Promise((resolve)=>{
        parseCsvWithPapa(existCsv, (results)=>{
          const rows = results.data || [];
          const header = (rows[0] || []).map(h => normalizeKey(h));

          existHeaderMap = new Map();
          header.forEach((h, idx)=>{ if(h) existHeaderMap.set(h, idx); });

          existRows = rows.slice(1).filter(r => r && r.length > 1);

          existIndexBySabang = new Map();
          existIndexByMall = new Map();

          const sabangIdx =
            existHeaderMap.get("사방넷주문번호") ??
            existHeaderMap.get("사방넷 주문번호") ??
            null;

          const mallIdx =
            existHeaderMap.get("쇼핑몰 주문번호(필수)") ??
            existHeaderMap.get("쇼핑몰 주문번호") ??
            null;

          for(const r of existRows){
            const sabang = normalizeKey(safeGet(r, sabangIdx));
            const mall = normalizeOrderNo(safeGet(r, mallIdx));

            if(sabang){
              if(!existIndexBySabang.has(sabang)) existIndexBySabang.set(sabang, []);
              existIndexBySabang.get(sabang).push(r);
            }
            if(mall){
              if(!existIndexByMall.has(mall)) existIndexByMall.set(mall, []);
              existIndexByMall.get(mall).push(r);
            }
          }

          existLoaded = true;
          resolve();
        });
      });

      setLoadingUI_(false, "로딩 완료");
      $("stat2").textContent =
        `재고 ${stockMap.size.toLocaleString()}개 · 발주 ${orderRows.length.toLocaleString()}건 · 주문번호 ${orderIndexMap.size.toLocaleString()}개 · 출고 ${existRows.length.toLocaleString()}행`;
    }catch(e){
      console.error(e);
      setLoadingUI_(false, "로드 실패: 시트가 '보기 가능' 공개인지 확인하세요.");
      throw e;
    }finally{
      $("btnSearch").disabled = false;
      orderExistLoadingPromise = null;
    }
  })();

  return orderExistLoadingPromise;
}

/* ===================== out row 생성 ===================== */
function buildOutFromSheetRow(row){
  const o = {};

  for(const c of EXTRA_COLS){
    o[c.key] = safeGet(row, c.idx);
  }

  for(const h of OUTPUT_HEADERS){
    if(h === "배송수단"){ o[h] = "택배"; continue; }
    if(h === "운송장 번호"){ o[h] = ""; continue; }

    if(h === "상품명"){
      o[h] = safeGet(row, 11) || "";
      continue;
    }

    if(h === "재고"){
      o[h] = "";
      continue;
    }

    const idx = headerIndexMap.get(h);
    o[h] = safeGet(row, idx);
  }

  o["재고"] = stockQtyLabel_(o["상품컬러코드"]);
  o["요청일"] = attachStockToRequestDate_(o["요청일"], o["상품컬러코드"]);

  return o;
}

/* ===================== 체크된 행 인덱스 ===================== */
function getCheckedIndexes_(){
  const wrap = $("tableWrap");
  const chks = wrap.querySelectorAll("input.rowChk:checked");
  return Array.from(chks).map(c => Number(c.dataset.idx)).filter(n => !Number.isNaN(n));
}

/* ===================== 툴바 ===================== */
function updateToolbar_(){
  const tb = $("tableToolbar");
  if(!tb) return;

  const hasRows = lastOutRows && lastOutRows.length > 0;
  tb.style.display = hasRows ? "flex" : "none";

  const showBulk = hasRows && lastOutRows.length > 1;
  $("btnSelectAll").style.display = showBulk ? "" : "none";
  $("btnSelectNone").style.display = showBulk ? "" : "none";

  const checked = getCheckedIndexes_().length;
  const selBadge = $("selCount");
  if(selBadge){
    selBadge.style.display = showBulk ? "" : "none";
    selBadge.textContent = `선택 ${checked}건`;
    selBadge.className = checked ? "badge ok" : "badge na";
  }
}

$("btnSelectAll")?.addEventListener("click", ()=>{
  const wrap = $("tableWrap");
  wrap.querySelectorAll("input.rowChk").forEach(c => c.checked = true);
  wrap.querySelectorAll("tbody tr").forEach(tr => tr.classList.add("is-selected"));
  refreshColorDropdownByCurrentRows_();
  updateToolbar_();
});
$("btnSelectNone")?.addEventListener("click", ()=>{
  const wrap = $("tableWrap");
  wrap.querySelectorAll("input.rowChk").forEach(c => c.checked = false);
  wrap.querySelectorAll("tbody tr").forEach(tr => tr.classList.remove("is-selected"));
  refreshColorDropdownByCurrentRows_();
  updateToolbar_();
});

/* ===================== 렌더 (툴팁 포함) ===================== */
function renderTable(outRows, stockTypes){
  const wrap = $("tableWrap");

  lastOutRows = outRows || [];
  lastStockTypes = stockTypes || [];

  clearStockUI();

  if(!outRows || outRows.length === 0){
    wrap.innerHTML = `<div class="no-data">검색 결과가 없습니다.</div>`;
    $("btnCopy").disabled = true;
    updateToolbar_();
    return;
  }

  gateCopyByTypes(stockTypes);

  const showCheckbox = outRows.length > 1;

  let html = `<table>
    <thead>
      <tr>
        <th style="min-width:48px;">#</th>
        <th style="min-width:64px;">선택</th>
        ${TABLE_COLS_VIEW.map(c=>{
          const w = COL_WIDTH[c.label] || COL_WIDTH["_default"];
          return `<th style="min-width:${w}px; max-width:${w}px;">${escapeHtml(c.label)}</th>`;
        }).join("")}
      </tr>
    </thead>
    <tbody>`;

  outRows.forEach((o, i)=>{
    const t = stockTypes[i] || "na";
    const trClass = t === "low" ? "low" : t === "out" ? "out" : t === "na" ? "na" : "";

    html += `<tr class="${trClass}">
      <td class="copy" data-copy="${i+1}" data-preview="${i+1}">${i+1}</td>
      <td class="chkcell">
        ${showCheckbox ? `<input type="checkbox" class="rowChk" data-idx="${i}">` : ``}
      </td>
      ${TABLE_COLS_VIEW.map(c=>{
        const v = o[c.key] ?? "";
        const w = COL_WIDTH[c.label] || COL_WIDTH["_default"];

        const pv = String(v ?? "").trim();
        const pvShort = pv.length > 500 ? (pv.slice(0, 500) + " …") : pv;

        return `<td class="copy"
          style="min-width:${w}px; max-width:${w}px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"
          data-copy="${escapeHtml(pv)}"
          data-preview="${escapeHtml(pvShort)}">
          ${escapeHtml(String(v))}
        </td>`;
      }).join("")}
    </tr>`;
  });

  html += `</tbody></table>`;
  wrap.innerHTML = html;

  refreshColorDropdownByCurrentRows_();

  wrap.querySelectorAll("input.rowChk").forEach(chk=>{
    chk.addEventListener("change", ()=>{
      const tr = chk.closest("tr");
      if(tr){
        tr.classList.toggle("is-selected", chk.checked);
      }
      refreshColorDropdownByCurrentRows_();
      updateToolbar_();
    });
  });

  updateToolbar_();

  wrap.querySelectorAll(".copy").forEach(td=>{
    td.addEventListener("click", async ()=>{
      const text = (td.getAttribute("data-copy") || td.textContent || "").trim();
      try{
        await navigator.clipboard.writeText(text);
        showToast("복사됨");
      }catch{
        showToast("복사 실패");
      }
    });
  });
}

/* ===================== TSV/HTML 복사 (숨긴 열도 포함) ===================== */
function buildTSV(outRows){
  const INCLUDE_HEADER_ROW = false;
  const lines = [];
  if(INCLUDE_HEADER_ROW){
    lines.push(TABLE_COLS_COPY.map(c => c.label).join("\t"));
  }
  outRows.forEach(o=>{
    const vals = TABLE_COLS_COPY.map(c =>
      String(o[c.key] ?? "").replace(/\t/g," ").replace(/\r?\n/g," ")
    );
    lines.push(vals.join("\t"));
  });
  return lines.join("\n");
}

function buildHTMLTable(outRows){
  const tdStyle = "border:1px solid #eee;padding:6px 8px;text-align:center;vertical-align:middle;";

  const tbody = outRows.map(o => {
    const tds = TABLE_COLS_COPY.map(c =>
      `<td style="${tdStyle}">${escapeHtml(String(o[c.key] ?? ""))}</td>`
    ).join("");
    return `<tr>${tds}</tr>`;
  }).join("");

  return `
    <table style="border-collapse:collapse;">
      <tbody>${tbody}</tbody>
    </table>
  `.trim();
}

/* ===================== 기존 등록 데이터/수동 입력/변경 기능은 원본과 동일 ===================== */
/* (여기부터 아래는 기존 기능을 유지하기 위해 그대로 포함) */

/* ===================== 수동 입력(out row) ===================== */
function buildOutManual(colorCode, qty){
  const o = {};
  for(const c of EXTRA_COLS) o[c.key] = "";
  for(const h of OUTPUT_HEADERS) o[h] = "";

  o["배송수단"] = "택배";
  o["운송장 번호"] = "";
  o["상품컬러코드"] = colorCode || "";
  o["수량"] = qty || "";

  o["상품명"] = nameFromStock_(o["상품컬러코드"]);
  o["재고"] = stockQtyLabel_(o["상품컬러코드"]);
  o["옵션(수집)"] = colorNameFromStock_(o["상품컬러코드"]);

  return o;
}

/* ===================== 데이터 저장 (발주서) ===================== */
let orderRows = [];
let orderIndexMap = new Map();

/* ===================== 상태 ===================== */
let lastOutRows = [];
let lastStockTypes = [];
let originalOutRows = [];
let lastSource = "none";

/* ===================== 기존 시트 로드 관련 상태 ===================== */
let existRows = [];
let existHeaderMap = new Map();

/* ===================== 검색 ===================== */
async function search(){
  const orderNo = normalizeOrderNo($("orderInput").value);

  setPanel("manual", false);
  setPanel("change", false);
  $("btnCopy").disabled = true;
  clearStockUI();
  hideExistPanel();

  lastOutRows = [];
  lastStockTypes = [];
  originalOutRows = [];
  lastSource = "none";

  if(!orderNo){
    $("tableWrap").innerHTML = `<div class="no-data">주문번호를 입력해주세요.</div>`;
    updateToolbar_();
    return;
  }

  if(!stockLoaded){
    $("status").textContent = "재고가 아직 로딩 중입니다…";
    return;
  }

  if(!orderLoaded || !existLoaded){
    try{
      await ensureOrderAndExistLoaded_();
    }catch{
      $("status").textContent = "발주/출고 로드 실패 (수동 입력 가능)";
      showExistPanelByOrderNo_(orderNo);
      setPanel("manual", true);
      $("tableWrap").innerHTML =
        `<div class="no-data">발주서/출고 시트를 불러오지 못했습니다.<br/>아래에서 <strong>상품컬러코드</strong>를 입력하면 재고 확인 후 결과 테이블을 만들 수 있어요.</div>`;
      updateToolbar_();
      return;
    }
  }

  const rows = orderIndexMap.get(orderNo) || [];
  $("status").textContent = rows.length
    ? `검색 결과: ${rows.length.toLocaleString()}건`
    : "검색 결과 없음 (수동 입력 가능)";

  if(rows.length === 0){
    showExistPanelByOrderNo_(orderNo);

    setPanel("manual", true);
    $("tableWrap").innerHTML =
      `<div class="no-data">발주서에서 주문번호를 찾지 못했습니다.<br/>아래에서 <strong>상품컬러코드</strong>를 입력하면 재고 확인 후 결과 테이블을 만들 수 있어요.</div>`;
    updateToolbar_();
    return;
  }

  const outRows = rows.map(r => buildOutFromSheetRow(r));
  const stockTypes = outRows.map(o => stockStatusByColorCode(o["상품컬러코드"]).type);

  lastSource = "sheet";
  originalOutRows = JSON.parse(JSON.stringify(outRows));
  renderTable(outRows, stockTypes);

  showExistPanelByOrderNo_(orderNo);

  setPanel("change", true);
  $("changeColor").value = normalizeKey(outRows[0]["상품컬러코드"] || "");
  $("changeQty").value = normalizeKey(outRows[0]["수량"] || "");
  refreshColorDropdownByCurrentRows_();
}

/* ===================== 수동 입력 ===================== */
function applyManual(){
  const color = normalizeKey($("manualColor").value);
  const qty = normalizeKey($("manualQty").value);

  if(!color){
    showToast("상품컬러코드를 입력해주세요");
    return;
  }
  if(!stockLoaded){
    showToast("재고 로딩 중…");
    return;
  }

  const out = buildOutManual(color, qty);
  const st = stockStatusByColorCode(out["상품컬러코드"]);

  lastSource = "manual";
  originalOutRows = JSON.parse(JSON.stringify([out]));

  $("status").textContent = "수동 입력 결과: 1건";
  renderTable([out], [st.type]);
}

/* ===================== 상품 변경 ===================== */
function applyChange(){
  if(lastSource !== "sheet" || !lastOutRows || lastOutRows.length === 0){
    showToast("변경할 검색 결과가 없습니다");
    return;
  }

  const newColor = normalizeKey($("changeColor").value);
  const newQty = normalizeKey($("changeQty").value);

  if(!newColor){
    showToast("변경 컬러코드를 입력해주세요");
    return;
  }

  let targets = [];
  if(lastOutRows.length > 1){
    targets = getCheckedIndexes_();
    if(targets.length === 0){
      showToast("여러 건이면 적용할 행을 체크해주세요");
      return;
    }
  }else{
    targets = [0];
  }
  const targetSet = new Set(targets);

  const updated = lastOutRows.map((o, idx)=>{
    const copy = { ...o };

    if(targetSet.has(idx)){
      copy["상품컬러코드"] = newColor;
      if(newQty !== "") copy["수량"] = newQty;

      copy["상품명"] = nameFromStock_(newColor);
      copy["요청일"] = attachStockToRequestDate_(copy["요청일"], newColor);
      copy["옵션(수집)"] = colorNameFromStock_(newColor);
    }else{
      if(copy["재고"] === "") copy["재고"] = stockQtyLabel_(copy["상품컬러코드"]);
    }

    return copy;
  });

  const types = updated.map(o => stockStatusByColorCode(o["상품컬러코드"]).type);
  renderTable(updated, types);
  showToast(`선택 ${targets.length}건에만 적용됨`);
}

function resetChange(){
  if(!originalOutRows || originalOutRows.length === 0){
    showToast("되돌릴 데이터가 없습니다");
    return;
  }
  const restored = JSON.parse(JSON.stringify(originalOutRows));
  const types = restored.map(o => stockStatusByColorCode(o["상품컬러코드"]).type);
  renderTable(restored, types);
  showToast("변경 취소됨");
}

/* ===================== EXIST 토글 버튼 ===================== */
$("btnExistToggle").addEventListener("click", ()=>{
  const body = $("existBody");
  const isOpen = body.style.display !== "none";
  body.style.display = isOpen ? "none" : "block";
  $("btnExistToggle").textContent = isOpen ? "펼치기" : "접기";
});

/* ===================== 복사 ===================== */
$("btnCopy").addEventListener("click", async ()=>{
  if(!lastOutRows || lastOutRows.length === 0){
    showToast("복사할 결과 없음");
    return;
  }
  if($("btnCopy").disabled){
    showToast("재고 경고로 복사 차단됨");
    return;
  }

  const tsv = buildTSV(lastOutRows);
  const html = buildHTMLTable(lastOutRows);

  try{
    await navigator.clipboard.write([
      new ClipboardItem({
        "text/plain": new Blob([tsv], { type: "text/plain" }),
        "text/html": new Blob([html], { type: "text/html" }),
      })
    ]);
    showToast(`통째로 복사됨 (${lastOutRows.length}건)`);
  }catch(e){
    try{
      await navigator.clipboard.writeText(tsv);
      showToast("복사됨 (서식 제외)");
    }catch{
      showToast("복사 실패");
    }
  }
});

/* ===================== 초기화 ===================== */
$("btnClear").addEventListener("click", ()=>{
  $("orderInput").value = "";
  $("manualColor").value = "";
  $("manualQty").value = "";
  $("changeColor").value = "";
  $("changeQty").value = "";

  const sel = $("changeColorSelect");
  if(sel) sel.value = "";

  $("status").textContent = "초기화됨";
  $("tableWrap").innerHTML = `<div class="no-data">검색 결과가 없습니다.</div>`;
  clearStockUI();
  hideExistPanel();
  setPanel("manual", false);
  setPanel("change", false);
  $("btnCopy").disabled = true;

  lastOutRows = [];
  lastStockTypes = [];
  originalOutRows = [];
  lastSource = "none";
  updateToolbar_();
});

/* ===================== 검색/버튼 이벤트 ===================== */
$("orderInput").addEventListener("keydown", (e)=>{
  if(e.key === "Enter") search();
});
$("btnSearch").addEventListener("click", search);
$("btnManualApply").addEventListener("click", applyManual);
$("btnChangeApply").addEventListener("click", applyChange);
$("btnChangeReset").addEventListener("click", resetChange);

/* ===================== 시작 ===================== */
loadStockOnly(); // ✅ 초기 로딩은 재고만
</script>
</body>
</html>
