<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Shipment</title>

  <link rel="stylesheet" as="style" crossorigin
    href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.css" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --surface:#ffffff;
      --text:#0f1222;
      --muted:#61657b;
      --line:#e7e8f2;
      --line2:#dadcf0;

      --p:#6f5cff;
      --pbg: rgba(111,92,255,.10);

      --shadow: 0 10px 24px rgba(17, 18, 40, .08);
      --shadow2: 0 6px 16px rgba(17, 18, 40, .06);

      --radius: 14px;

      /* Fixed columns width */
      --w-idx: 44px;
      --w-chk: 34px;
      --w-name: 320px;

      /* Dense table */
      --row-h: 38px;
      --th-h: 40px;
      --font: 12.5px;
    }

    *{ box-sizing:border-box; font-family:"Pretendard",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; }
    body{ margin:0; background:var(--bg); color:var(--text); }

    .app{ max-width: 1640px; margin:0 auto; padding: 0 14px 86px; }

    /* ===== App Bar ===== */
    .bar{
      position: sticky;
      top: 0;
      z-index: 60;
      background: rgba(246,247,251,.82);
      backdrop-filter: blur(14px);
      border-bottom: 1px solid var(--line);
    }
    .bar-inner{
      max-width: 1640px;
      margin: 0 auto;
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight: 950;
      letter-spacing: -0.2px;
      user-select:none;
      white-space:nowrap;
    }
    .logo{
      width:10px; height:10px; border-radius: 999px;
      background: var(--p);
      box-shadow: 0 0 0 4px rgba(111,92,255,.12);
    }
    .controls{
      display:flex;
      align-items:center;
      gap:10px;
      flex: 1 1 520px;
      min-width: 280px;
    }
    .input{
      flex: 1;
      min-width: 240px;
      height: 40px;
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 0 12px;
      background: rgba(255,255,255,.88);
      border: 1px solid var(--line2);
      border-radius: 12px;
      box-shadow: var(--shadow2);
    }
    .input span{
      font-size: 12px;
      font-weight: 900;
      color: var(--muted);
      white-space:nowrap;
    }
    .input input{
      width: 100%;
      border:0; outline:0;
      background: transparent;
      font-size: 13px;
      color: var(--text);
    }
    .btn{
      height: 40px;
      padding: 0 12px;
      border-radius: 12px;
      border: 1px solid var(--line2);
      background: rgba(255,255,255,.88);
      box-shadow: var(--shadow2);
      font-weight: 900;
      color: rgba(20, 18, 40, .92);
      cursor:pointer;
      transition: .12s ease;
      white-space: nowrap;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(111,92,255,.35); box-shadow: 0 0 0 4px rgba(111,92,255,.10), var(--shadow2); }
    .btn:disabled{ cursor:not-allowed; opacity:.55; transform:none; box-shadow:none; }

    .links{
      display:flex;
      align-items:center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }
    .pill{
      height: 40px;
      display:inline-flex;
      align-items:center;
      padding: 0 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.84);
      border: 1px solid var(--line2);
      box-shadow: var(--shadow2);
      text-decoration:none;
      color: rgba(20,18,40,.92);
      font-weight: 900;
      font-size: 12px;
      transition: .12s ease;
      white-space:nowrap;
    }
    .pill:hover{ transform: translateY(-1px); border-color: rgba(111,92,255,.30); box-shadow: 0 0 0 4px rgba(111,92,255,.10), var(--shadow2); }

    /* ===== Status sentence ===== */
    .status{
      max-width: 1640px;
      margin: 0 auto;
      padding: 10px 14px 12px;
      color: rgba(40, 38, 70, .92);
      font-size: 13px;
      line-height: 1.4;
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .status .muted{ color: var(--muted); font-weight: 800; }
    .status .tag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line2);
      background: rgba(255,255,255,.82);
      font-size: 12px;
      font-weight: 900;
      color: rgba(20,18,40,.92);
      box-shadow: var(--shadow2);
      white-space: nowrap;
    }
    .tag.ok{ border-color: rgba(111,92,255,.28); background: rgba(111,92,255,.10); color: rgba(55,45,160,.95); }
    .tag.low{ border-color: rgba(255,153,0,.35); background: rgba(255,153,0,.12); color: rgba(130,65,0,.95); }
    .tag.out{ border-color: rgba(255,60,90,.35); background: rgba(255,60,90,.12); color: rgba(150,0,35,.98); }
    .tag.na { border-color: rgba(120,120,150,.25); background: rgba(120,120,150,.10); color: rgba(90,92,110,.95); }

    .spinner{
      width:14px; height:14px; border-radius:999px;
      border:2px solid rgba(111,92,255,.20);
      border-top-color: rgba(111,92,255,.95);
      animation: spin .8s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg);} }

    /* ===== Main surface ===== */
    .main{
      margin-top: 12px;
      background: var(--surface);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .table-wrap{
      width: 100%;
      overflow: auto;
      max-height: calc(100vh - 200px);
      scrollbar-gutter: stable;
    }

    table{
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: var(--font);
    }

    thead th{
      position: sticky;
      top: 0;
      z-index: 10;
      height: var(--th-h);
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line);
      color: rgba(25,22,45,.92);
      font-weight: 950;
      text-align: left;
      padding: 0 10px;
      white-space: nowrap;
    }

    tbody td{
      height: var(--row-h);
      border-bottom: 1px solid rgba(231,232,242,.9);
      padding: 0 10px;
      color: rgba(18,18,34,.95);
      white-space: nowrap;
      vertical-align: middle;
    }

    /* IMPORTANT: prevent native text-selection drag; we do row-drag selection UX */
    tbody td, tbody tr{ user-select: none; }

    tbody tr:hover{ background: rgba(111,92,255,.06); }

    /* Row left status bar */
    tbody tr{ position: relative; }
    tbody tr::before{
      content:"";
      position:absolute; left:0; top:0; bottom:0;
      width: 2px;
      background: transparent;
    }
    tbody tr.low::before{ background: rgba(255,153,0,.95); }
    tbody tr.out::before{ background: rgba(255,60,90,.95); }
    tbody tr.na::before{ background: rgba(120,120,150,.75); }
    tbody tr.ok::before{ background: transparent; }

    /* Selection focus line (higher priority than status bar) */
    tbody tr.is-selected::before{ background: rgba(111,92,255,.95); width: 3px; }

    /* Sticky columns */
    .sticky{ position: sticky; z-index: 8; background: inherit; }
    .col-idx{ left: 0; min-width: var(--w-idx); max-width: var(--w-idx); }
    .col-chk{ left: var(--w-idx); min-width: var(--w-chk); max-width: var(--w-chk); text-align:center; }
    .col-name{ left: calc(var(--w-idx) + var(--w-chk)); min-width: var(--w-name); max-width: var(--w-name); }
    thead .sticky{ z-index: 20; background: rgba(255,255,255,.92); }

    .cell{
      max-width: 520px;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: default;
    }
    .copyable{ cursor: pointer; }
    .copyable:hover{ color: rgba(60,45,170,.98); }

    .rowChk{
      width: 14px; height: 14px;
      accent-color: var(--p);
      cursor: pointer;
      opacity: .85;
    }

    .nodata{
      padding: 18px 14px;
      color: rgba(97,101,123,.90);
      font-size: 13px;
      text-align:center;
    }

    /* ===== Popover preview ===== */
    .popover{
      position: fixed;
      z-index: 2000;
      width: min(520px, calc(100vw - 28px));
      display:none;
      pointer-events: none;
    }
    .popover.show{ display:block; }
    .popover-inner{
      pointer-events: auto;
      background: rgba(255,255,255,.96);
      border: 1px solid rgba(218,220,240,.9);
      border-radius: 12px;
      box-shadow: 0 18px 60px rgba(17,18,40,.16);
      overflow: hidden;
    }
    .popover-head{
      padding: 8px 10px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      background: rgba(250,250,255,.9);
      font-size: 12px;
      font-weight: 950;
      color: rgba(45,40,80,.92);
    }
    .popover-body{
      padding: 10px;
      font-size: 12.5px;
      font-weight: 700;
      color: rgba(18,18,34,.95);
      line-height: 1.4;
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 240px;
      overflow:auto;
    }
    .popover-actions{
      display:flex; gap:8px; padding: 10px; border-top: 1px solid var(--line);
      background: rgba(255,255,255,.92);
      justify-content:flex-end;
    }
    .mini{
      height: 34px;
      padding: 0 10px;
      border-radius: 10px;
      border: 1px solid var(--line2);
      background: rgba(255,255,255,.9);
      font-weight: 900;
      cursor:pointer;
      transition: .12s ease;
      pointer-events: auto;
    }
    .mini:hover{ border-color: rgba(111,92,255,.30); box-shadow: 0 0 0 4px rgba(111,92,255,.10); }
    .mini.primary{
      border-color: rgba(111,92,255,.50);
      background: rgba(111,92,255,.92);
      color:#fff;
    }

    /* ===== Modal ===== */
    .modal-backdrop{
      position: fixed;
      inset: 0;
      display:none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      background: rgba(12, 12, 24, .45);
      z-index: 3000;
    }
    .modal-backdrop.show{ display:flex; }
    .modal{
      width: min(980px, 96vw);
      max-height: min(86vh, 800px);
      overflow: auto;
      background: #fff;
      border-radius: 14px;
      border: 1px solid rgba(218,220,240,.95);
      box-shadow: 0 28px 90px rgba(10, 10, 25, .28);
    }
    .modal-head{
      position: sticky;
      top: 0;
      z-index: 1;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--line);
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .modal-title{
      font-weight: 950;
      color: rgba(25,22,45,.92);
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .modal-body{
      padding: 14px;
      white-space: pre-wrap;
      word-break: break-word;
      line-height: 1.5;
      font-size: 13px;
      color: rgba(18,18,34,.96);
    }

    /* ===== Bottom helper ===== */
    .bottom{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 14px;
      width: min(1200px, calc(100vw - 28px));
      z-index: 1000;
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 12px;
      padding: 10px 12px;
      background: rgba(255,255,255,.88);
      backdrop-filter: blur(14px);
      border: 1px solid rgba(218,220,240,.95);
      border-radius: 14px;
      box-shadow: 0 18px 60px rgba(17,18,40,.14);
    }
    .bottom .left{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      color: rgba(40,38,70,.92);
      font-size: 12.5px;
      font-weight: 900;
    }
    .bottom .right{
      display:flex; align-items:center; gap: 8px; flex-wrap: wrap;
    }
    .bottom .hint{
      font-weight: 800;
      color: var(--muted);
    }
    .kbd{
      padding: 2px 6px;
      border: 1px solid rgba(218,220,240,.95);
      border-radius: 8px;
      background: rgba(255,255,255,.9);
      font-size: 11px;
      font-weight: 950;
      color: rgba(25,22,45,.92);
    }

    /* ===== Toast ===== */
    #toast{
      position: fixed;
      right: 18px;
      bottom: 18px;
      z-index: 4000;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(218,220,240,.95);
      box-shadow: var(--shadow);
      opacity: 0;
      transform: translateY(10px);
      transition: .16s ease;
      pointer-events:none;
      font-weight: 950;
      color: rgba(25,22,45,.92);
    }
    #toast.show{ opacity: 1; transform: translateY(0); }
  </style>
</head>

<body>

  <!-- App Bar -->
  <div class="bar">
    <div class="bar-inner">
      <div class="brand"><span class="logo"></span> Shipment</div>

      <div class="controls">
        <div class="input">
          <span>주문번호</span>
          <input id="orderInput" type="text" placeholder="주문번호 입력 후 Enter" />
        </div>
        <button class="btn" id="btnClear" type="button">초기화</button>
      </div>

      <div class="links">
        <a class="pill" id="orderLink" href="#" target="_blank" rel="noopener noreferrer">발주서</a>
        <a class="pill" id="stockLink" href="#" target="_blank" rel="noopener noreferrer">재고</a>
        <a class="pill" id="existLink" href="#" target="_blank" rel="noopener noreferrer">출고</a>
      </div>
    </div>

    <div class="status" id="statusLine">
      <span class="spinner" aria-hidden="true"></span>
      <span><b>재고</b> 데이터를 불러오는 중입니다…</span>
      <span class="muted">· Enter: 조회 · Ctrl/Cmd+C: 선택(또는 전체) 복사 · 선택 대상에 LOW/OUT/N/A 포함 시 복사 차단</span>
    </div>
  </div>

  <div class="app">
    <div class="main">
      <div class="table-wrap" id="tableWrap">
        <div class="nodata">검색 결과가 없습니다.</div>
      </div>
    </div>
  </div>

  <!-- Bottom helper -->
  <div class="bottom" id="bottomBar">
    <div class="left">
      <span id="bottomText">대기</span>
      <span class="hint">· 행 드래그로 범위 선택 → Ctrl/Cmd+C 복사 · 체크박스 선택도 동일</span>
    </div>
    <div class="right">
      <span class="kbd">Enter</span><span class="hint">조회</span>
      <span class="kbd">Ctrl/Cmd + C</span><span class="hint">복사</span>
      <span class="kbd">Esc</span><span class="hint">닫기</span>
    </div>
  </div>

  <!-- Popover -->
  <div class="popover" id="popover">
    <div class="popover-inner">
      <div class="popover-head">
        <span id="popTitle">미리보기</span>
        <span style="opacity:.7; font-weight:900;" id="popMeta"></span>
      </div>
      <div class="popover-body" id="popBody"></div>
      <div class="popover-actions">
        <button class="mini" id="popCopy" type="button">값 복사</button>
        <button class="mini primary" id="popOpen" type="button">전체 보기</button>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-head">
        <div class="modal-title"><span class="logo" style="width:9px;height:9px; box-shadow:none;"></span> <span id="modalTitle">전체 보기</span></div>
        <div style="display:flex; gap:8px; align-items:center;">
          <button class="btn" id="btnModalCopy" type="button" style="height:36px;">복사</button>
          <button class="btn" id="btnModalClose" type="button" style="height:36px;">닫기</button>
        </div>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast">복사됨</div>

<script>
/* ===================== 기준 ===================== */
const LOW_STOCK_THRESHOLD = 10;

/* ===================== 시트 ===================== */
// 발주서
const ORDER_SHEET_URL_VIEW =
  "https://docs.google.com/spreadsheets/d/1_Bxfag-90U6u-6JbhxNqeoD9vRns-CpPeXPIJYO1Z5o/edit?gid=518656308#gid=518656308";
const ORDER_CSV_BASE =
  "https://docs.google.com/spreadsheets/d/1_Bxfag-90U6u-6JbhxNqeoD9vRns-CpPeXPIJYO1Z5o/export?format=csv&gid=518656308";

// 재고 시트
const STOCK_SHEET_URL_VIEW =
  "https://docs.google.com/spreadsheets/d/1_L12NKkBVU4c5xDPrYLUQRnSUG2NoAwYGWIfPDVO3bM/edit?gid=366983013#gid=366983013";
const STOCK_CSV_BASE =
  "https://docs.google.com/spreadsheets/d/1_L12NKkBVU4c5xDPrYLUQRnSUG2NoAwYGWIfPDVO3bM/export?format=csv&gid=366983013";

// 출고 시트(현재 UI에 표출은 안 하지만, 링크/로딩은 유지)
const EXIST_SHEET_URL_VIEW =
  "https://docs.google.com/spreadsheets/d/1LPy69E2yPTaSwxFAYrX6qV0BZx1tW0YdonLRNqeo5Vc/edit?gid=0#gid=0";
const EXIST_CSV_BASE =
  "https://docs.google.com/spreadsheets/d/1LPy69E2yPTaSwxFAYrX6qV0BZx1tW0YdonLRNqeo5Vc/export?format=csv&gid=0";

document.getElementById("orderLink").href = ORDER_SHEET_URL_VIEW;
document.getElementById("stockLink").href = STOCK_SHEET_URL_VIEW;
document.getElementById("existLink").href = EXIST_SHEET_URL_VIEW;

/* ===================== 강제 포함 B/C/D ===================== */
// CSV 0-based: A=0, B=1, C=2, D=3
const EXTRA_COLS = [
  { key: "__B", label: "사방넷주문번호", idx: 1 },
  { key: "__C", label: "쇼핑몰 주문번호(필수)", idx: 2 },
  { key: "__D", label: "쇼핑몰", idx: 3 },
];

/* ===================== 요청 출력 컬럼 (복사 원본용) ===================== */
const OUTPUT_HEADERS = [
  "요청일",
  "수령인","배송수단","운송장 번호","받는분연락처","받는분 기타연락처","주소","배송메세지",
  "상품명","수량","결제금액","큐텐(한글상품명)","바코드","큐텐바코드",
  "상품코드","쇼핑몰(참고용)","상품컬러코드","상품명(수집)","옵션(수집)","주문자명",
  "비고"
];

/* ===================== 화면 표시 컬럼(세련된 기본 셋) ===================== */
const VIEW_COLS = [
  { key:"요청일", label:"요청일" },
  { key:"__B", label:"사방넷주문번호" },
  { key:"__C", label:"쇼핑몰 주문번호(필수)" },
  { key:"__D", label:"쇼핑몰" },
  { key:"상품명", label:"상품명" },
  { key:"수량", label:"수량" },
  { key:"상품컬러코드", label:"상품컬러코드" },
  { key:"옵션(수집)", label:"옵션(수집)" },
  { key:"바코드", label:"바코드" },
  { key:"상품코드", label:"상품코드" },
  { key:"비고", label:"비고" },
];

/* ✅ 복사(원본 전체 열) : 숨김 포함 전체 */
const TABLE_COLS_COPY = [
  { key: "요청일", label: "요청일" },
  ...EXTRA_COLS.map(c => ({ key:c.key, label:c.label })),
  { key: "수령인", label: "수령인" },
  ...OUTPUT_HEADERS
    .filter(h => !["요청일","수령인"].includes(h))
    .map(h => ({ key:h, label:h }))
];

/* 컬럼 폭(일부만) */
const COL_WIDTH = {
  "요청일": 110,
  "사방넷주문번호": 130,
  "쇼핑몰 주문번호(필수)": 170,
  "쇼핑몰": 120,
  "상품명": 420,
  "수량": 70,
  "상품컬러코드": 150,
  "옵션(수집)": 140,
  "바코드": 140,
  "상품코드": 120,
  "비고": 220,
  "_default": 140
};

/* ===================== 유틸 ===================== */
const $ = (id)=>document.getElementById(id);

function showToast(msg="복사됨"){
  const el = $("toast");
  el.textContent = msg;
  el.classList.add("show");
  setTimeout(()=>el.classList.remove("show"), 850);
}

function normalizeKey(v){
  return String(v ?? "")
    .replace(/[\u200B-\u200D\uFEFF]/g, "")
    .trim();
}
function normalizeOrderNo(v){ return normalizeKey(v); }
function normColorCode(v){
  return normalizeKey(v).replace(/\s+/g,"").replace(/-/g,"").toUpperCase();
}
function toNumber(v){
  const n = String(v ?? "").replace(/[^0-9.-]/g,"");
  return Number(n) || 0;
}
function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function safeGet(row, idx){
  if(!row || idx == null || idx < 0) return "";
  return (row[idx] ?? "");
}
function withCacheBust(url){
  const sep = url.includes("?") ? "&" : "?";
  return `${url}${sep}_=${Date.now()}`;
}
function looksLikeBadCsv(text){
  const t = String(text || "").trim();
  if(!t) return true;
  const head = t.slice(0, 220).toLowerCase();
  if(head.includes("<!doctype") || head.includes("<html") || head.includes("servicelogin")) return true;
  if(t.length < 30) return true;
  return false;
}
async function fetchText(url, timeoutMs = 9000){
  const controller = new AbortController();
  const t = setTimeout(()=>controller.abort(), timeoutMs);
  try{
    const res = await fetch(url, { signal: controller.signal, cache: "no-store" });
    if(!res.ok) throw new Error("HTTP " + res.status);
    return await res.text();
  } finally {
    clearTimeout(t);
  }
}
async function fetchCsvSmart(baseUrl, timeoutMs=9000){
  const t1 = await fetchText(baseUrl, timeoutMs).catch(()=> "");
  if(!looksLikeBadCsv(t1)) return t1;

  const t2 = await fetchText(withCacheBust(baseUrl), timeoutMs).catch(()=> "");
  if(!looksLikeBadCsv(t2)) return t2;

  return t2 || t1;
}

/* ===================== Status sentence ===================== */
function setStatusSentence_(html){
  $("statusLine").innerHTML = html;
}
function tagHtml(type, text){
  const cls = type === "ok" ? "tag ok"
            : type === "low" ? "tag low"
            : type === "out" ? "tag out"
            : "tag na";
  return `<span class="${cls}">${escapeHtml(text)}</span>`;
}

/* ===================== 파서 ===================== */
function parseCsvWithPapa(csvText, onDone){
  Papa.parse(csvText, {
    skipEmptyLines: true,
    worker: true,
    complete: (results)=> onDone(results)
  });
}

/* ===================== 재고 ===================== */
let stockMap = new Map();
let stockLoaded = false;

function stockStatusByColorCode(colorCodeRaw){
  const code = normColorCode(colorCodeRaw);
  if(!code) return { type:"na", label:"재고 미등록", qty:null };
  if(!stockMap.has(code)) return { type:"na", label:"재고 미등록", qty:null };
  const qty = stockMap.get(code);
  if(qty <= 0) return { type:"out", label:`재고 0`, qty };
  if(qty < LOW_STOCK_THRESHOLD) return { type:"low", label:`재고 ${qty} (<${LOW_STOCK_THRESHOLD})`, qty };
  return { type:"ok", label:`재고 ${qty}`, qty };
}
function stockQtyLabel_(colorCodeRaw){
  const code = normColorCode(colorCodeRaw);
  if(!code) return "미등록";
  if(!stockMap.has(code)) return "미등록";
  return String(stockMap.get(code));
}
function stripStockTag_(s){
  return String(s ?? "").replace(/\s*\[재고:.*?\]\s*/g, " ").trim();
}
function attachStockToRequestDate_(reqDate, colorCode){
  const base = stripStockTag_(reqDate);
  const code = normColorCode(colorCode);
  let qtyLabel = "미등록";
  if(code && stockMap.has(code)) qtyLabel = String(stockMap.get(code));
  const tag = `[재고:${qtyLabel}]`;
  return base ? `${base}  ${tag}` : tag;
}
function buildStockMapsFromParsed_(results){
  const rows = (results.data || []).slice(1).filter(r => r && r.length > 0);
  stockMap = new Map();
  for(const r of rows){
    const code = normColorCode(r[0]);
    if(!code) continue;
    const qty = toNumber(r[10]);
    stockMap.set(code, qty);
  }
}

/* ===================== localStorage 캐시 (재고만) ===================== */
const STOCK_CACHE_KEY = "SHIPMENT_STOCK_CSV_CACHE_V1";
const STOCK_CACHE_TTL_MS = 10 * 60 * 1000;
function loadStockCache_(){
  try{
    const raw = localStorage.getItem(STOCK_CACHE_KEY);
    if(!raw) return null;
    const obj = JSON.parse(raw);
    if(!obj || !obj.csv || !obj.ts) return null;
    if(Date.now() - obj.ts > STOCK_CACHE_TTL_MS) return null;
    return obj.csv;
  }catch{ return null; }
}
function saveStockCache_(csv){
  try{ localStorage.setItem(STOCK_CACHE_KEY, JSON.stringify({ ts: Date.now(), csv })); }catch{}
}

async function loadStockOnly(){
  setStatusSentence_(`<span class="spinner"></span><span><b>재고</b> 데이터를 불러오는 중입니다…</span><span class="muted">· Enter: 조회 · Ctrl/Cmd+C: 복사</span>`);
  try{
    const cached = loadStockCache_();
    if(cached){
      await new Promise((resolve)=>{
        parseCsvWithPapa(cached, (results)=>{ buildStockMapsFromParsed_(results); resolve(); });
      });
      stockLoaded = true;
      setStatusSentence_(`${tagHtml("ok","재고 캐시 로딩")}<span class="muted">재고 ${stockMap.size.toLocaleString()}개 · 주문번호 입력 후 Enter</span>`);
    }

    const stockCsv = await fetchCsvSmart(STOCK_CSV_BASE);
    if(!looksLikeBadCsv(stockCsv)){
      saveStockCache_(stockCsv);
      await new Promise((resolve)=>{
        parseCsvWithPapa(stockCsv, (results)=>{ buildStockMapsFromParsed_(results); resolve(); });
      });
      stockLoaded = true;
      setStatusSentence_(`${tagHtml("ok","재고 로딩 완료")}<span class="muted">재고 ${stockMap.size.toLocaleString()}개 · 주문번호 입력 후 Enter</span>`);
    }else{
      if(!stockLoaded){
        setStatusSentence_(`${tagHtml("out","재고 로드 실패")}<span class="muted">시트 공개(보기 가능) 여부를 확인하세요</span>`);
      }
    }
  }catch(e){
    console.error(e);
    if(!stockLoaded){
      setStatusSentence_(`${tagHtml("out","재고 로드 실패")}<span class="muted">시트 공개(보기 가능) 여부를 확인하세요</span>`);
    }
  }
}

/* ===================== 발주/출고 Lazy Load ===================== */
let orderLoaded = false;
let existLoaded = false;
let orderExistLoadingPromise = null;

let orderRows = [];
let orderIndexMap = new Map();
let headerIndexMap = new Map();

function getMatchIndexFromHeader_(){
  const idx = headerIndexMap.get("쇼핑몰 주문번호(필수)");
  if(idx == null){
    const idx2 = headerIndexMap.get("쇼핑몰 주문번호");
    if(idx2 != null) return idx2;
  }
  return 2;
}

async function ensureOrderAndExistLoaded_(){
  if(orderLoaded && existLoaded) return;
  if(orderExistLoadingPromise) return orderExistLoadingPromise;

  orderExistLoadingPromise = (async ()=>{
    setStatusSentence_(`<span class="spinner"></span><span><b>발주/출고</b> 데이터를 불러오는 중입니다…</span>`);
    try{
      const [orderCsv, existCsv] = await Promise.all([
        fetchCsvSmart(ORDER_CSV_BASE),
        fetchCsvSmart(EXIST_CSV_BASE),
      ]);

      await new Promise((resolve)=>{
        parseCsvWithPapa(orderCsv, (results)=>{
          const rows = results.data || [];
          const header = (rows[0] || []).map(h => normalizeKey(h));

          headerIndexMap = new Map();
          header.forEach((h, idx)=>{ if(h) headerIndexMap.set(h, idx); });

          orderRows = rows.slice(1).filter(r => r && r.length > 1);
          const matchIdx = getMatchIndexFromHeader_();

          orderIndexMap = new Map();
          for(const r of orderRows){
            const k = normalizeOrderNo(r[matchIdx]);
            if(!k) continue;
            if(!orderIndexMap.has(k)) orderIndexMap.set(k, []);
            orderIndexMap.get(k).push(r);
          }
          orderLoaded = true;
          resolve();
        });
      });

      await new Promise((resolve)=>{
        parseCsvWithPapa(existCsv, ()=>{ existLoaded = true; resolve(); });
      });

      setStatusSentence_(`${tagHtml("ok","준비 완료")}<span class="muted">주문번호 입력 후 Enter</span>`);
    }catch(e){
      console.error(e);
      setStatusSentence_(`${tagHtml("out","로드 실패")}<span class="muted">시트가 '보기 가능' 공개인지 확인하세요</span>`);
      throw e;
    }finally{
      orderExistLoadingPromise = null;
    }
  })();

  return orderExistLoadingPromise;
}

/* ===================== out row 생성 ===================== */
function buildOutFromSheetRow(row){
  const o = {};

  for(const c of EXTRA_COLS){
    o[c.key] = safeGet(row, c.idx);
  }

  for(const h of OUTPUT_HEADERS){
    if(h === "배송수단"){ o[h] = "택배"; continue; }
    if(h === "운송장 번호"){ o[h] = ""; continue; }
    if(h === "상품명"){ o[h] = safeGet(row, 11) || ""; continue; }

    const idx = headerIndexMap.get(h);
    o[h] = safeGet(row, idx);
  }

  o["요청일"] = attachStockToRequestDate_(o["요청일"], o["상품컬러코드"]);
  o["재고"] = stockQtyLabel_(o["상품컬러코드"]);

  return o;
}

/* ===================== 상태 ===================== */
let lastOutRows = [];
let lastStockTypes = [];

/* ===================== 선택/복사 규칙 ===================== */
/* - 체크 있으면: 체크된 행만 복사
   - 체크 없으면: 전체 복사
   - 복사 대상에 LOW/OUT/N/A 포함이면 복사 차단 (A안)
   - 행 드래그로도 선택 가능(체크/선택 동기화)
*/
function getCheckedIndexes_(){
  const wrap = $("tableWrap");
  const chks = wrap.querySelectorAll("input.rowChk:checked");
  return Array.from(chks).map(c => Number(c.dataset.idx)).filter(n => !Number.isNaN(n));
}
function getSelectedIndexes_(){
  const wrap = $("tableWrap");
  const trs = wrap.querySelectorAll("tbody tr.is-selected");
  return Array.from(trs).map(tr => Number(tr.dataset.row)).filter(n => !Number.isNaN(n));
}
function getCopyTargetIndexes_(){
  if(!lastOutRows || lastOutRows.length === 0) return [];
  const checked = getCheckedIndexes_();
  // 체크가 우선(명시적)
  if(checked.length) return checked;

  const sel = getSelectedIndexes_();
  if(sel.length) return sel;

  // 아무 것도 없으면 전체
  return lastOutRows.map((_, i)=>i);
}
function summarizeTypesByIndexes_(idxs){
  const counts = { ok:0, low:0, out:0, na:0 };
  for(const i of idxs){
    const t = stockStatusByColorCode(lastOutRows[i]?.["상품컬러코드"]).type;
    counts[t] = (counts[t] || 0) + 1;
  }
  return counts;
}
function computeGate_(){
  const total = lastOutRows.length;
  const checked = getCheckedIndexes_().length;
  const sel = getSelectedIndexes_().length;
  const targetIdxs = getCopyTargetIndexes_();
  const counts = summarizeTypesByIndexes_(targetIdxs);

  const blocked = (counts.low + counts.out + counts.na) > 0;

  let gateType = "ok";
  let gateMsg = "복사 가능";
  if(blocked){
    if(counts.out) { gateType="out"; gateMsg="선택 대상에 OUT(재고 0)이 포함되어 복사 불가"; }
    else if(counts.low){ gateType="low"; gateMsg=`선택 대상에 LOW(재고 < ${LOW_STOCK_THRESHOLD}) 포함으로 복사 불가`; }
    else { gateType="na"; gateMsg="선택 대상에 N/A(재고 미등록) 포함으로 복사 불가"; }
  }

  if(total === 0){
    setStatusSentence_(`${tagHtml("na","대기")}<span class="muted">주문번호 입력 후 Enter</span>`);
    $("bottomText").textContent = "대기";
    return { blocked:true, targetIdxs:[], total:0 };
  }

  const scope =
    checked ? `체크 ${checked}건` :
    sel ? `선택 ${sel}건` :
    `전체 ${total}건`;

  const badge = blocked ? tagHtml(gateType, "복사 차단") : tagHtml("ok", "복사 가능");
  const scopeTag = checked ? tagHtml("ok", `복사대상: 체크 ${checked}`) : (sel ? tagHtml("ok", `복사대상: 선택 ${sel}`) : tagHtml("na", `복사대상: 전체 ${total}`));

  const mixTag = [
    counts.out ? tagHtml("out", `OUT ${counts.out}`) : "",
    counts.low ? tagHtml("low", `LOW ${counts.low}`) : "",
    counts.na  ? tagHtml("na",  `N/A ${counts.na}`) : "",
    counts.ok  ? tagHtml("ok",  `OK ${counts.ok}`) : "",
  ].filter(Boolean).join(" ");

  setStatusSentence_(
    `${badge} ${scopeTag} ${mixTag} <span class="muted">· ${escapeHtml(gateMsg)} · Enter: 조회 · Ctrl/Cmd+C: 복사</span>`
  );

  $("bottomText").textContent = `총 ${total}건 · ${scope} · ${blocked ? "복사 차단" : "복사 가능"}`;

  return { blocked, targetIdxs, total };
}

/* ===================== 렌더 ===================== */
function renderTable(outRows){
  const wrap = $("tableWrap");
  lastOutRows = outRows || [];
  lastStockTypes = (outRows || []).map(o => stockStatusByColorCode(o["상품컬러코드"]).type);

  if(!outRows || outRows.length === 0){
    wrap.innerHTML = `<div class="nodata">검색 결과가 없습니다.</div>`;
    computeGate_();
    return;
  }

  let html = `<table id="resultTable">
    <thead>
      <tr>
        <th class="sticky col-idx">#</th>
        <th class="sticky col-chk">✓</th>
        <th class="sticky col-name">${escapeHtml("상품명")}</th>
        ${VIEW_COLS.filter(c=>c.label!=="상품명").map(c=>{
          const w = COL_WIDTH[c.label] || COL_WIDTH["_default"];
          return `<th style="min-width:${w}px; max-width:${w}px;">${escapeHtml(c.label)}</th>`;
        }).join("")}
      </tr>
    </thead>
    <tbody>`;

  outRows.forEach((o, i)=>{
    const t = lastStockTypes[i] || "na";
    const name = String(o["상품명"] ?? "");

    const cells = VIEW_COLS.filter(c=>c.label!=="상품명").map(c=>{
      const w = COL_WIDTH[c.label] || COL_WIDTH["_default"];
      const raw = String(o[c.key] ?? "");
      return `<td class="cell copyable"
                data-row="${i}"
                data-key="${escapeHtml(c.label)}"
                data-full="${escapeHtml(raw)}"
                style="min-width:${w}px; max-width:${w}px;"
              >${escapeHtml(raw)}</td>`;
    }).join("");

    html += `<tr class="${t}" data-row="${i}">
      <td class="sticky col-idx cell copyable" data-row="${i}" data-key="#" data-full="${escapeHtml(String(i+1))}">${i+1}</td>
      <td class="sticky col-chk" style="text-align:center;">
        <input type="checkbox" class="rowChk" data-idx="${i}">
      </td>
      <td class="sticky col-name cell copyable"
          data-row="${i}"
          data-key="상품명"
          data-full="${escapeHtml(name)}"
      >${escapeHtml(name)}</td>
      ${cells}
    </tr>`;
  });

  html += `</tbody></table>`;
  wrap.innerHTML = html;

  // checkbox ↔ selected row sync
  wrap.querySelectorAll("input.rowChk").forEach(chk=>{
    chk.addEventListener("change", ()=>{
      const tr = chk.closest("tr");
      if(tr) tr.classList.toggle("is-selected", chk.checked);
      computeGate_();
    });
  });

  // cell click: value copy (편의)
  wrap.querySelectorAll("td.copyable").forEach(td=>{
    td.addEventListener("click", async ()=>{
      const text = (td.getAttribute("data-full") || td.textContent || "").trim();
      if(!text){ showToast("빈 값"); return; }
      try{ await navigator.clipboard.writeText(text); showToast("값 복사됨"); }
      catch{ showToast("복사 실패"); }
    });

    td.addEventListener("dblclick", ()=>{
      const key = td.getAttribute("data-key") || "값";
      const text = (td.getAttribute("data-full") || td.textContent || "").trim();
      openModal_(`${key}\n\n${text}`, `${key} 전체 보기`);
    });

    td.addEventListener("mouseenter", (e)=> showPopover_(td, e));
    td.addEventListener("mousemove", (e)=> movePopover_(e));
    td.addEventListener("mouseleave", ()=> hidePopover_());
  });

  // ✅ Row drag selection
  wireRowDragSelection_();

  computeGate_();
}

/* ===================== 행 드래그 선택 ===================== */
let drag = { on:false, start:-1, end:-1, additive:false };

function clearAllRowSelection_(){
  const wrap = $("tableWrap");
  wrap.querySelectorAll("tbody tr").forEach(tr=>tr.classList.remove("is-selected"));
  wrap.querySelectorAll("input.rowChk").forEach(chk=>chk.checked = false);
}

function applyRangeSelection_(a, b, additive=false){
  const wrap = $("tableWrap");
  const trs = Array.from(wrap.querySelectorAll("tbody tr"));
  if(trs.length === 0) return;

  const min = Math.min(a,b);
  const max = Math.max(a,b);

  if(!additive){
    clearAllRowSelection_();
  }

  for(let i=min; i<=max; i++){
    const tr = trs[i];
    if(!tr) continue;
    tr.classList.add("is-selected");
    const chk = tr.querySelector("input.rowChk");
    if(chk) chk.checked = true; // 드래그 선택은 “체크”로 취급
  }
}

function wireRowDragSelection_(){
  const wrap = $("tableWrap");
  const tbody = wrap.querySelector("tbody");
  if(!tbody) return;

  // mousedown on row (ignore checkbox clicks)
  tbody.addEventListener("mousedown", (e)=>{
    const target = e.target;
    if(target && (target.closest("input.rowChk") || target.tagName === "INPUT")) return;

    const tr = target.closest("tr");
    if(!tr) return;

    const idx = Number(tr.dataset.row);
    if(Number.isNaN(idx)) return;

    drag.on = true;
    drag.start = idx;
    drag.end = idx;
    drag.additive = e.ctrlKey || e.metaKey;

    applyRangeSelection_(drag.start, drag.end, drag.additive);
    computeGate_();

    // prevent accidental text selection
    e.preventDefault();
  });

  tbody.addEventListener("mousemove", (e)=>{
    if(!drag.on) return;
    const tr = e.target.closest("tr");
    if(!tr) return;
    const idx = Number(tr.dataset.row);
    if(Number.isNaN(idx)) return;
    if(idx === drag.end) return;
    drag.end = idx;
    applyRangeSelection_(drag.start, drag.end, drag.additive);
    computeGate_();
  });

  document.addEventListener("mouseup", ()=>{
    if(!drag.on) return;
    drag.on = false;
  }, { passive:true });
}

/* ===================== 검색 (Enter 전용) ===================== */
async function search(){
  const orderNo = normalizeOrderNo($("orderInput").value);

  if(!orderNo){
    $("tableWrap").innerHTML = `<div class="nodata">주문번호를 입력해주세요.</div>`;
    lastOutRows = [];
    computeGate_();
    return;
  }
  if(!stockLoaded){
    $("tableWrap").innerHTML = `<div class="nodata">재고가 아직 로딩 중입니다…</div>`;
    return;
  }

  $("tableWrap").innerHTML = `<div class="nodata"><span class="spinner"></span> 조회 중…</div>`;
  setStatusSentence_(`<span class="spinner"></span><span><b>조회</b> 중입니다…</span>`);

  if(!orderLoaded || !existLoaded){
    try{ await ensureOrderAndExistLoaded_(); }
    catch{
      $("tableWrap").innerHTML = `<div class="nodata">발주/출고 시트를 불러오지 못했습니다. (시트 공개 확인)</div>`;
      lastOutRows = [];
      computeGate_();
      return;
    }
  }

  const rows = orderIndexMap.get(orderNo) || [];
  if(rows.length === 0){
    $("tableWrap").innerHTML = `<div class="nodata">발주서에서 주문번호를 찾지 못했습니다.</div>`;
    lastOutRows = [];
    computeGate_();
    return;
  }

  const outRows = rows.map(r => buildOutFromSheetRow(r));
  renderTable(outRows);
}

/* ===================== 복사 (Ctrl/Cmd+C 전용) ===================== */
function buildTSV(outRows){
  const lines = [];
  outRows.forEach(o=>{
    const vals = TABLE_COLS_COPY.map(c =>
      String(o[c.key] ?? "").replace(/\t/g," ").replace(/\r?\n/g," ")
    );
    lines.push(vals.join("\t"));
  });
  return lines.join("\n");
}
function buildHTMLTable(outRows){
  const tdStyle = "border:1px solid #eee;padding:6px 8px;text-align:center;vertical-align:middle;";
  const tbody = outRows.map(o => {
    const tds = TABLE_COLS_COPY.map(c =>
      `<td style="${tdStyle}">${escapeHtml(String(o[c.key] ?? ""))}</td>`
    ).join("");
    return `<tr>${tds}</tr>`;
  }).join("");

  return `<table style="border-collapse:collapse;"><tbody>${tbody}</tbody></table>`;
}
async function copyRows_(rowsToCopy){
  const tsv = buildTSV(rowsToCopy);
  const html = buildHTMLTable(rowsToCopy);

  try{
    await navigator.clipboard.write([
      new ClipboardItem({
        "text/plain": new Blob([tsv], { type: "text/plain" }),
        "text/html": new Blob([html], { type: "text/html" }),
      })
    ]);
    showToast(`통째로 복사됨 (${rowsToCopy.length}건)`);
  }catch{
    try{
      await navigator.clipboard.writeText(tsv);
      showToast("복사됨 (서식 제외)");
    }catch{
      showToast("복사 실패");
    }
  }
}

async function copyByShortcut_(){
  if(!lastOutRows || lastOutRows.length === 0){
    showToast("복사할 결과 없음");
    return;
  }
  const gate = computeGate_();
  if(gate.blocked){
    showToast("재고 경고로 복사 차단됨");
    return;
  }
  const rowsToCopy = gate.targetIdxs.map(i => lastOutRows[i]);
  await copyRows_(rowsToCopy);
}

/* ✅ Ctrl/Cmd+C 핫키:
   - 체크 있으면 체크만
   - 체크 없고 행 드래그/선택 있으면 선택만
   - 아무 것도 없으면 전체
   - 항상 “원본 전체 열(TABLE_COLS_COPY)”로 복사
*/
document.addEventListener("keydown", async (e)=>{
  // modal open 상태면 modal copy는 유지(기존 버튼 제공)
  const modalOpen = $("modalBackdrop").classList.contains("show");

  // Ctrl/Cmd + C
  if((e.ctrlKey || e.metaKey) && (e.key === "c" || e.key === "C")){
    // 입력칸에서 Ctrl+C는 원래 복사도 필요할 수 있음 → 하지만 너는 “복사=출력복사”가 중요하다고 했으니,
    // 입력칸에서도 결과가 있으면 결과 복사를 우선한다.
    const hasResults = lastOutRows && lastOutRows.length > 0;
    if(hasResults && !modalOpen){
      e.preventDefault();
      await copyByShortcut_();
    }
  }
});

/* ===================== Popover ===================== */
let popCurrent = { key:"", text:"", row: null };

function showPopover_(td, evt){
  const key = td.getAttribute("data-key") || "";
  const text = (td.getAttribute("data-full") || td.textContent || "").trim();
  if(text.length <= 16) return;

  popCurrent = { key, text, row: td.getAttribute("data-row") };

  $("popTitle").textContent = key || "미리보기";
  $("popMeta").textContent = popCurrent.row != null ? `#${Number(popCurrent.row)+1}` : "";
  $("popBody").textContent = text;

  const pop = $("popover");
  pop.classList.add("show");
  movePopover_(evt);
}
function movePopover_(evt){
  const pop = $("popover");
  if(!pop.classList.contains("show")) return;

  const pad = 12;
  const w = pop.getBoundingClientRect().width || 520;

  let x = evt.clientX + 14;
  let y = evt.clientY + 14;

  if(x + w + pad > window.innerWidth) x = window.innerWidth - w - pad;
  if(y + 260 + pad > window.innerHeight) y = window.innerHeight - 260 - pad;
  if(x < pad) x = pad;
  if(y < pad) y = pad;

  pop.style.left = x + "px";
  pop.style.top = y + "px";
}
function hidePopover_(){
  $("popover").classList.remove("show");
}

$("popCopy").addEventListener("click", async ()=>{
  const t = popCurrent.text || "";
  if(!t.trim()){ showToast("복사할 내용 없음"); return; }
  try{ await navigator.clipboard.writeText(t); showToast("복사됨"); }
  catch{ showToast("복사 실패"); }
});
$("popOpen").addEventListener("click", ()=>{
  const key = popCurrent.key || "전체 보기";
  const t = popCurrent.text || "";
  openModal_(`${key}\n\n${t}`, `${key} 전체 보기`);
});

/* ===================== Modal ===================== */
let modalCopyPayload = "";
function openModal_(text, title){
  modalCopyPayload = String(text ?? "");
  $("modalBody").textContent = modalCopyPayload;
  $("modalTitle").textContent = title || "전체 보기";
  $("modalBackdrop").classList.add("show");
}
function closeModal_(){
  $("modalBackdrop").classList.remove("show");
  modalCopyPayload = "";
  $("modalBody").textContent = "";
}
$("btnModalClose").addEventListener("click", closeModal_);
$("modalBackdrop").addEventListener("click", (e)=>{
  if(e.target === $("modalBackdrop")) closeModal_();
});
$("btnModalCopy").addEventListener("click", async ()=>{
  if(!modalCopyPayload.trim()){ showToast("복사할 내용 없음"); return; }
  try{ await navigator.clipboard.writeText(modalCopyPayload); showToast("복사됨"); }
  catch{ showToast("복사 실패"); }
});
document.addEventListener("keydown", (e)=>{
  if(e.key === "Escape") closeModal_();
});

/* ===================== 초기화 ===================== */
$("btnClear").addEventListener("click", ()=>{
  $("orderInput").value = "";
  lastOutRows = [];
  lastStockTypes = [];
  $("tableWrap").innerHTML = `<div class="nodata">검색 결과가 없습니다.</div>`;
  computeGate_();
});

/* ===================== Enter 조회 ===================== */
$("orderInput").addEventListener("keydown", (e)=>{
  if(e.key === "Enter") search();
});

/* ===================== 시작 ===================== */
loadStockOnly().then(()=>computeGate_());
</script>
</body>
</html>
